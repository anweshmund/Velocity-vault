<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Services - Velocity Vault</title>
    <link rel="stylesheet" href="../styles/maintenance.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left">
            <a href="../index.html" class="back-home">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
        </div>
        <div class="nav-right">
            <div class="user-profile">
                <i class="fas fa-user"></i>
                <span id="userName">Guest</span>
            </div>
        </div>
    </nav>

    <div class="maintenance-container">
        <div class="service-dashboard">
            <div class="vehicle-info">
                <h2>Your Vehicles</h2>
                <button id="addVehicleBtn" class="add-vehicle-btn">
                    <i class="fas fa-plus"></i> Add Vehicle
                </button>
                <div id="vehicleList" class="vehicle-list">
                    <!-- Vehicles will be added here dynamically -->
                </div>
            </div>

            <div class="service-schedule">
                <h2>Maintenance Schedule</h2>
                <div class="schedule-calendar">
                    <div class="calendar-header">
                        <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="currentMonth">September 2023</h3>
                        <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar" class="calendar-grid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>

            <div class="service-history">
                <h2>Service History</h2>
                <div id="serviceHistoryList" class="history-list">
                    <!-- Service history will be added here dynamically -->
                </div>
            </div>
        </div>

        <div class="maintenance-services">
            <h2>Available Services</h2>
            <div class="services-grid">
                <div class="service-card" data-service="oil-change">
                    <i class="fas fa-oil-can"></i>
                    <h3>Oil Change</h3>
                    <p>Regular oil changes to keep your engine running smoothly</p>
                    <p class="price">From Rs. 2,999</p>
                    <button class="book-service-btn">Book Now</button>
                </div>
                <div class="service-card" data-service="brake-service">
                    <i class="fas fa-brake-disc"></i>
                    <h3>Brake Service</h3>
                    <p>Comprehensive brake inspection and maintenance</p>
                    <p class="price">From Rs. 4,999</p>
                    <button class="book-service-btn">Book Now</button>
                </div>
                <div class="service-card" data-service="tire-service">
                    <i class="fas fa-tire"></i>
                    <h3>Tire Service</h3>
                    <p>Rotation, balancing, and alignment services</p>
                    <p class="price">From Rs. 1,999</p>
                    <button class="book-service-btn">Book Now</button>
                </div>
                <div class="service-card" data-service="diagnostic">
                    <i class="fas fa-laptop-code"></i>
                    <h3>Diagnostic Scan</h3>
                    <p>Complete vehicle health check and diagnostics</p>
                    <p class="price">From Rs. 3,499</p>
                    <button class="book-service-btn">Book Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="addVehicleModal" class="modal">
        <div class="modal-content">
            <h2>Add New Vehicle</h2>
            <form id="addVehicleForm">
                <div class="form-group">
                    <label for="vehicleMake">Make:</label>
                    <input type="text" id="vehicleMake" required>
                </div>
                <div class="form-group">
                    <label for="vehicleModel">Model:</label>
                    <input type="text" id="vehicleModel" required>
                </div>
                <div class="form-group">
                    <label for="vehicleYear">Year:</label>
                    <input type="number" id="vehicleYear" min="1900" max="2024" required>
                </div>
                <div class="form-group">
                    <label for="vehiclePlate">License Plate:</label>
                    <input type="text" id="vehiclePlate" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="submit-btn">Add Vehicle</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <h2>Schedule Service</h2>
            <form id="bookingForm">
                <div class="form-group">
                    <label for="serviceVehicle">Select Vehicle:</label>
                    <select id="serviceVehicle" required>
                        <!-- Vehicles will be added here dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="serviceDate">Preferred Date:</label>
                    <input type="date" id="serviceDate" required>
                </div>
                <div class="form-group">
                    <label for="serviceTime">Preferred Time:</label>
                    <select id="serviceTime" required>
                        <option value="09:00">09:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="14:00">02:00 PM</option>
                        <option value="15:00">03:00 PM</option>
                        <option value="16:00">04:00 PM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="serviceNotes">Additional Notes:</label>
                    <textarea id="serviceNotes"></textarea>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="submit-btn">Schedule Service</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // State Management
        const state = {
            vehicles: JSON.parse(localStorage.getItem('vehicles')) || [],
            appointments: JSON.parse(localStorage.getItem('appointments')) || [],
            serviceHistory: JSON.parse(localStorage.getItem('serviceHistory')) || [],
            currentDate: new Date(),
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            loading: false,
            selectedVehicle: null,
            notifications: []
        };

        // Constants
        const SERVICE_INTERVALS = {
            'oil-change': { months: 6, kilometers: 5000 },
            'brake-service': { months: 12, kilometers: 20000 },
            'tire-service': { months: 6, kilometers: 10000 },
            'diagnostic': { months: 12, kilometers: 15000 },
            'full-service': { months: 12, kilometers: 25000 }
        };

        const SERVICE_PRICES = {
            'oil-change': 2999,
            'brake-service': 4999,
            'tire-service': 1999,
            'diagnostic': 3499,
            'full-service': 8999
        };

        // Utility Functions
        function setLoading(loading) {
            state.loading = loading;
            document.body.style.cursor = loading ? 'wait' : 'default';
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loading) {
                if (!loadingOverlay) {
                    const overlay = document.createElement('div');
                    overlay.id = 'loadingOverlay';
                    overlay.innerHTML = `
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Loading...</span>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }
            } else if (loadingOverlay) {
                loadingOverlay.remove();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function validateVehicleForm(formData) {
            const errors = [];
            const currentYear = new Date().getFullYear();
            
            if (!formData.make.match(/^[a-zA-Z0-9\s-]+$/)) {
                errors.push('Make should only contain letters, numbers, spaces, and hyphens');
            }
            
            if (!formData.model.match(/^[a-zA-Z0-9\s-]+$/)) {
                errors.push('Model should only contain letters, numbers, spaces, and hyphens');
            }
            
            if (formData.year < 1900 || formData.year > currentYear + 1) {
                errors.push(`Year must be between 1900 and ${currentYear + 1}`);
            }
            
            if (!formData.plate.match(/^[A-Z0-9\s-]+$/)) {
                errors.push('License plate should only contain uppercase letters, numbers, spaces, and hyphens');
            }
            
            return errors;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }).format(new Date(date));
        }

        // Enhanced Vehicle Management
        const addVehicleForm = document.getElementById('addVehicleForm');
        addVehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            const formData = {
                make: document.getElementById('vehicleMake').value.trim(),
                model: document.getElementById('vehicleModel').value.trim(),
                year: parseInt(document.getElementById('vehicleYear').value),
                plate: document.getElementById('vehiclePlate').value.trim().toUpperCase()
            };

            const errors = validateVehicleForm(formData);
            if (errors.length > 0) {
                showNotification(errors.join('\n'), 'error');
                setLoading(false);
                return;
            }

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));

                const newVehicle = {
                    id: Date.now(),
                    ...formData,
                    lastService: null,
                    nextService: null,
                    mileage: 0,
                    serviceReminders: [],
                    serviceHistory: []
                };

                state.vehicles.push(newVehicle);
                localStorage.setItem('vehicles', JSON.stringify(state.vehicles));
                displayVehicles();
                addVehicleModal.style.display = 'none';
                addVehicleForm.reset();
                showNotification('Vehicle added successfully!');
            } catch (error) {
                showNotification('Failed to add vehicle. Please try again.', 'error');
            } finally {
                setLoading(false);
            }
        });

        // Real-time Form Validation
        document.getElementById('vehicleMake').addEventListener('input', validateField);
        document.getElementById('vehicleModel').addEventListener('input', validateField);
        document.getElementById('vehicleYear').addEventListener('input', validateField);
        document.getElementById('vehiclePlate').addEventListener('input', validateField);

        function validateField(e) {
            const field = e.target;
            const value = field.value.trim();
            const fieldName = field.id.replace('vehicle', '').toLowerCase();
            let error = '';

            switch (fieldName) {
                case 'make':
                case 'model':
                    if (!value.match(/^[a-zA-Z0-9\s-]*$/)) {
                        error = 'Only letters, numbers, spaces, and hyphens allowed';
                    }
                    break;
                case 'year':
                    const currentYear = new Date().getFullYear();
                    if (value && (value < 1900 || value > currentYear + 1)) {
                        error = `Year must be between 1900 and ${currentYear + 1}`;
                    }
                    break;
                case 'plate':
                    if (!value.match(/^[A-Z0-9\s-]*$/)) {
                        error = 'Only uppercase letters, numbers, spaces, and hyphens allowed';
                    }
                    break;
            }

            const errorElement = field.parentElement.querySelector('.field-error');
            if (error) {
                if (!errorElement) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'field-error';
                    errorDiv.textContent = error;
                    field.parentElement.appendChild(errorDiv);
                } else {
                    errorElement.textContent = error;
                }
                field.classList.add('error');
            } else {
                if (errorElement) {
                    errorElement.remove();
                }
                field.classList.remove('error');
            }

            // Update submit button state
            const submitBtn = addVehicleForm.querySelector('.submit-btn');
            const hasErrors = addVehicleForm.querySelectorAll('.field-error').length > 0;
            submitBtn.disabled = hasErrors;
        }

        // Enhanced Vehicle Display
        function displayVehicles() {
            const vehicleList = document.getElementById('vehicleList');
            if (state.vehicles.length === 0) {
                vehicleList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-car"></i>
                        <h3>No Vehicles Added</h3>
                        <p>Click the "Add Vehicle" button to get started</p>
                    </div>
                `;
                return;
            }

            vehicleList.innerHTML = state.vehicles.map(vehicle => {
                const lastService = vehicle.lastService ? formatDate(vehicle.lastService) : 'No service yet';
                const nextService = vehicle.nextService ? formatDate(vehicle.nextService) : 'Not scheduled';
                const dueForService = vehicle.nextService && new Date(vehicle.nextService) <= new Date();
                const serviceStatus = getServiceStatus(vehicle);
                
                return `
                    <div class="vehicle-card ${dueForService ? 'service-due' : ''}" data-vehicle-id="${vehicle.id}">
                        <div class="vehicle-info">
                            <div class="vehicle-header">
                                <h3>${vehicle.year} ${vehicle.make} ${vehicle.model}</h3>
                                <span class="status-badge ${serviceStatus.class}">${serviceStatus.text}</span>
                            </div>
                            <div class="vehicle-details">
                                <p><i class="fas fa-id-card"></i> Plate: ${vehicle.plate}</p>
                                <p><i class="fas fa-history"></i> Last Service: ${lastService}</p>
                                <p><i class="fas fa-calendar"></i> Next Service: ${nextService}</p>
                                <p><i class="fas fa-tachometer-alt"></i> Mileage: ${vehicle.mileage.toLocaleString()} km</p>
                            </div>
                            ${dueForService ? '<span class="service-alert">Service Due!</span>' : ''}
                        </div>
                        <div class="vehicle-actions">
                            <button onclick="viewServiceHistory(${vehicle.id})" class="action-btn history-btn">
                                <i class="fas fa-history"></i> History
                            </button>
                            <button onclick="scheduleService(${vehicle.id})" class="action-btn schedule-btn">
                                <i class="fas fa-calendar-plus"></i> Schedule
                            </button>
                            <button onclick="updateMileage(${vehicle.id})" class="action-btn mileage-btn">
                                <i class="fas fa-tachometer-alt"></i> Update Mileage
                            </button>
                            <button onclick="deleteVehicle(${vehicle.id})" class="action-btn delete-btn">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="service-recommendations">
                            ${getServiceRecommendations(vehicle).map(rec => `
                                <div class="recommendation">
                                    <i class="fas ${rec.icon}"></i>
                                    <span>${rec.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add drag-and-drop reordering
            const vehicleCards = vehicleList.querySelectorAll('.vehicle-card');
            vehicleCards.forEach(card => {
                card.draggable = true;
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
            });
        }

        // Drag and Drop Functionality
        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = e.target;
            e.target.style.opacity = '0.4';
        }

        function handleDragOver(e) {
            e.preventDefault();
            return false;
        }

        function handleDrop(e) {
            e.preventDefault();
            const card = e.target.closest('.vehicle-card');
            if (card && card !== draggedCard) {
                const allCards = [...card.parentNode.children];
                const draggedIdx = allCards.indexOf(draggedCard);
                const droppedIdx = allCards.indexOf(card);

                if (draggedIdx < droppedIdx) {
                    card.parentNode.insertBefore(draggedCard, card.nextSibling);
                } else {
                    card.parentNode.insertBefore(draggedCard, card);
                }

                // Update vehicles array order
                const newOrder = [...document.querySelectorAll('.vehicle-card')]
                    .map(card => parseInt(card.dataset.vehicleId));
                state.vehicles = newOrder.map(id => 
                    state.vehicles.find(v => v.id === id)
                );
                localStorage.setItem('vehicles', JSON.stringify(state.vehicles));
            }
            draggedCard.style.opacity = '1';
            return false;
        }

        // Service Status and Recommendations
        function getServiceStatus(vehicle) {
            if (!vehicle.lastService) {
                return { text: 'Never Serviced', class: 'status-warning' };
            }

            const lastService = new Date(vehicle.lastService);
            const monthsSinceService = (new Date() - lastService) / (1000 * 60 * 60 * 24 * 30);
            const mileageSinceService = vehicle.mileage - (vehicle.lastServiceMileage || 0);

            if (monthsSinceService > 12 || mileageSinceService > 20000) {
                return { text: 'Service Overdue', class: 'status-danger' };
            } else if (monthsSinceService > 10 || mileageSinceService > 15000) {
                return { text: 'Service Due Soon', class: 'status-warning' };
            } else {
                return { text: 'Service Up to Date', class: 'status-success' };
            }
        }

        function getServiceRecommendations(vehicle) {
            const recommendations = [];
            const lastService = vehicle.lastService ? new Date(vehicle.lastService) : null;
            const monthsSinceService = lastService ? 
                (new Date() - lastService) / (1000 * 60 * 60 * 24 * 30) : 0;
            const mileageSinceService = vehicle.mileage - (vehicle.lastServiceMileage || 0);

            if (!lastService) {
                recommendations.push({
                    icon: 'fa-exclamation-triangle',
                    text: 'Initial service recommended'
                });
            }

            if (monthsSinceService >= 6) {
                recommendations.push({
                    icon: 'fa-oil-can',
                    text: 'Oil change recommended'
                });
            }

            if (mileageSinceService >= 10000) {
                recommendations.push({
                    icon: 'fa-tire',
                    text: 'Tire rotation recommended'
                });
            }

            if (monthsSinceService >= 12) {
                recommendations.push({
                    icon: 'fa-brake-disc',
                    text: 'Brake inspection recommended'
                });
            }

            return recommendations;
        }

        // Modal Management
        const addVehicleBtn = document.getElementById('addVehicleBtn');
        const addVehicleModal = document.getElementById('addVehicleModal');
        const bookingModal = document.getElementById('bookingModal');
        const cancelButtons = document.querySelectorAll('.cancel-btn');

        addVehicleBtn.addEventListener('click', () => {
            addVehicleModal.style.display = 'flex';
        });

        cancelButtons.forEach(button => {
            button.addEventListener('click', () => {
                button.closest('.modal').style.display = 'none';
            });
        });

        // Calendar Functions
        function generateCalendar(month = state.currentMonth, year = state.currentYear) {
            const calendar = document.getElementById('calendar');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            document.getElementById('currentMonth').textContent = 
                firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const days = [];
            const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Add week day headers
            weekDays.forEach(day => {
                days.push(`<div class="calendar-weekday">${day}</div>`);
            });

            // Add empty cells for days before first day of month
            for (let i = 0; i < firstDay.getDay(); i++) {
                days.push('<div class="calendar-day empty"></div>');
            }

            // Add days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(year, month, day);
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                const appointments = getAppointmentsForDate(date);
                const hasAppointment = appointments.length > 0;
                
                days.push(`
                    <div class="calendar-day ${isToday ? 'today' : ''} ${hasAppointment ? 'has-appointment' : ''}" 
                         data-date="${date.toISOString().split('T')[0]}"
                         onclick="showAppointments('${date.toISOString()}')">
                        ${day}
                        ${hasAppointment ? `
                            <div class="appointment-indicator"></div>
                            <div class="appointment-count">${appointments.length}</div>
                        ` : ''}
                    </div>
                `);
            }

            calendar.innerHTML = days.join('');
        }

        // Calendar Navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            state.currentMonth--;
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            }
            generateCalendar(state.currentMonth, state.currentYear);
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            state.currentMonth++;
            if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            generateCalendar(state.currentMonth, state.currentYear);
        });

        // Appointment Management
        function getAppointmentsForDate(date) {
            return state.appointments.filter(apt => 
                new Date(apt.date).toDateString() === date.toDateString()
            );
        }

        function showAppointments(dateString) {
            const date = new Date(dateString);
            const dayAppointments = getAppointmentsForDate(date);
            
            if (dayAppointments.length === 0) {
                showNotification('No appointments scheduled for this date');
                return;
            }

            const appointmentsList = dayAppointments.map(apt => {
                const vehicle = state.vehicles.find(v => v.id === apt.vehicleId);
                return `
                    <div class="appointment-item">
                        <p><strong>Time:</strong> ${apt.time}</p>
                        <p><strong>Vehicle:</strong> ${vehicle.year} ${vehicle.make} ${vehicle.model}</p>
                        <p><strong>Service:</strong> ${apt.serviceType}</p>
                        <p><strong>Notes:</strong> ${apt.notes || 'No notes'}</p>
                        <button onclick="cancelAppointment(${apt.id})" class="cancel-appointment-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                `;
            }).join('');

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Appointments for ${formatDate(date)}</h2>
                    ${appointmentsList}
                    <button class="cancel-btn" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function cancelAppointment(appointmentId) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                const index = state.appointments.findIndex(apt => apt.id === appointmentId);
                if (index !== -1) {
                    state.appointments.splice(index, 1);
                    localStorage.setItem('appointments', JSON.stringify(state.appointments));
                    generateCalendar(state.currentMonth, state.currentYear);
                    showNotification('Appointment cancelled successfully');
                    document.querySelector('.modal').remove();
                }
            }
        }

        // Vehicle Management Functions
        function viewServiceHistory(vehicleId) {
            const vehicle = state.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            const historyModal = document.createElement('div');
            historyModal.className = 'modal';
            
            const serviceHistory = state.serviceHistory.filter(sh => sh.vehicleId === vehicleId);
            const historyContent = serviceHistory.length > 0 ? serviceHistory.map(service => `
                <div class="history-item">
                    <div class="service-date">
                        <strong>${formatDate(service.date)}</strong>
                    </div>
                    <div class="service-details">
                        <p><strong>Service Type:</strong> ${service.serviceType}</p>
                        <p><strong>Mileage:</strong> ${service.mileage.toLocaleString()} km</p>
                        <p><strong>Notes:</strong> ${service.notes || 'No notes'}</p>
                    </div>
                    <div class="service-cost">
                        <strong>${formatCurrency(service.cost)}</strong>
                    </div>
                </div>
            `).join('') : '<p class="empty-history">No service history available</p>';

            historyModal.innerHTML = `
                <div class="modal-content">
                    <h2>Service History - ${vehicle.year} ${vehicle.make} ${vehicle.model}</h2>
                    <div class="history-list">
                        ${historyContent}
                    </div>
                    <button class="cancel-btn" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            `;
            document.body.appendChild(historyModal);
            historyModal.style.display = 'flex';
        }

        function updateMileage(vehicleId) {
            const vehicle = state.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            const mileageModal = document.createElement('div');
            mileageModal.className = 'modal';
            mileageModal.innerHTML = `
                <div class="modal-content">
                    <h2>Update Mileage</h2>
                    <form id="mileageForm">
                        <div class="form-group">
                            <label for="newMileage">Current Mileage (km):</label>
                            <input type="number" id="newMileage" min="${vehicle.mileage}" 
                                   value="${vehicle.mileage}" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="submit-btn">Update</button>
                            <button type="button" class="cancel-btn" onclick="this.closest('.modal').remove()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(mileageModal);
            mileageModal.style.display = 'flex';

            document.getElementById('mileageForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newMileage = parseInt(document.getElementById('newMileage').value);
                if (newMileage < vehicle.mileage) {
                    showNotification('New mileage cannot be less than current mileage', 'error');
                    return;
                }

                vehicle.mileage = newMileage;
                localStorage.setItem('vehicles', JSON.stringify(state.vehicles));
                displayVehicles();
                mileageModal.remove();
                showNotification('Mileage updated successfully');
                checkServiceDue(vehicle);
            });
        }

        function deleteVehicle(vehicleId) {
            if (confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) {
                const index = state.vehicles.findIndex(v => v.id === vehicleId);
                if (index !== -1) {
                    state.vehicles.splice(index, 1);
                    localStorage.setItem('vehicles', JSON.stringify(state.vehicles));
                    
                    // Remove related appointments and service history
                    state.appointments = state.appointments.filter(apt => apt.vehicleId !== vehicleId);
                    state.serviceHistory = state.serviceHistory.filter(sh => sh.vehicleId !== vehicleId);
                    
                    localStorage.setItem('appointments', JSON.stringify(state.appointments));
                    localStorage.setItem('serviceHistory', JSON.stringify(state.serviceHistory));
                    
                    displayVehicles();
                    generateCalendar();
                    showNotification('Vehicle removed successfully');
                }
            }
        }

        // Service Booking
        function scheduleService(vehicleId) {
            const vehicle = state.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            const serviceTypeSelect = document.getElementById('serviceType');
            const serviceVehicleSelect = document.getElementById('serviceVehicle');
            const serviceDate = document.getElementById('serviceDate');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            serviceDate.min = today;
            
            serviceVehicleSelect.innerHTML = `
                <option value="${vehicle.id}">
                    ${vehicle.year} ${vehicle.make} ${vehicle.model}
                </option>
            `;

            bookingModal.style.display = 'flex';
        }

        document.getElementById('bookingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const vehicleId = parseInt(document.getElementById('serviceVehicle').value);
            const serviceDate = document.getElementById('serviceDate').value;
            const serviceTime = document.getElementById('serviceTime').value;
            const serviceType = document.getElementById('serviceType').value;
            const notes = document.getElementById('serviceNotes').value;

            // Check if there's already an appointment at this time
            const existingAppointment = state.appointments.find(apt => 
                apt.date === serviceDate && apt.time === serviceTime
            );

            if (existingAppointment) {
                showNotification('This time slot is already booked. Please choose another time.', 'error');
                return;
            }

            const appointment = {
                id: Date.now(),
                vehicleId,
                date: serviceDate,
                time: serviceTime,
                serviceType,
                notes
            };

            state.appointments.push(appointment);
            localStorage.setItem('appointments', JSON.stringify(state.appointments));

            // Update vehicle service records
            const vehicle = state.vehicles.find(v => v.id === vehicleId);
            vehicle.lastService = new Date().toISOString();
            vehicle.nextService = new Date(serviceDate);
            vehicle.nextService.setMonth(vehicle.nextService.getMonth() + 3);
            localStorage.setItem('vehicles', JSON.stringify(state.vehicles));

            generateCalendar(state.currentMonth, state.currentYear);
            displayVehicles();
            bookingModal.style.display = 'none';
            e.target.reset();
            showNotification('Service scheduled successfully!');
        });

        // Service Reminders
        function checkServiceReminders() {
            state.vehicles.forEach(vehicle => {
                if (vehicle.nextService) {
                    const nextService = new Date(vehicle.nextService);
                    const today = new Date();
                    const daysUntilService = Math.ceil((nextService - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntilService <= 7 && daysUntilService > 0) {
                        showNotification(
                            `Service due in ${daysUntilService} days for ${vehicle.year} ${vehicle.make} ${vehicle.model}`,
                            'warning'
                        );
                    }
                }

                // Check mileage-based service intervals
                const mileageSinceService = vehicle.mileage - (vehicle.lastServiceMileage || 0);
                if (mileageSinceService >= 5000) {
                    showNotification(
                        `Service recommended for ${vehicle.year} ${vehicle.make} ${vehicle.model} - ${mileageSinceService}km since last service`,
                        'warning'
                    );
                }
            });
        }

        // Service Card Booking
        document.querySelectorAll('.book-service-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (state.vehicles.length === 0) {
                    showNotification('Please add a vehicle first', 'error');
                    return;
                }
                const serviceCard = btn.closest('.service-card');
                const serviceType = serviceCard.dataset.service;
                
                // Pre-select service type in booking modal
                document.getElementById('serviceType').value = serviceType;
                bookingModal.style.display = 'flex';
            });
        });

        // Initialize the page
        displayVehicles();
        generateCalendar();
        checkServiceReminders();
    </script>
</body>
</html> 